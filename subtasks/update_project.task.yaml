name: Add Samples to VarSeq Cohort 
auto_generate_session_for_account: "{workspaceBot}"
description: |-
  # Add Samples to Variant Cohort 
  
  This task updates an existing VarSeq cohort project by adding new sample files.
  It automatically finds the most recent project version, creates a new timestamped
  project, imports the new files, downloads required sources, and executes saved
  exports. If no existing project is found, it creates a new one from the template.

agent_requirements:
  cpu_cores: 8
  memory_gb: 16

parameters:
  - name: project_base_path
    type: directory
    label: The Project Base Path
    help: The base path where the project will be created and stored

  - name: project_name
    type: string
    label: The Project Base Name 
    help: The base name for the new project. The final project name will include a timestamp to ensure uniqueness.

  - name: files_to_add
    type: directory
    label: The input directory of the new files to add
    help: The directory containing the files to be added to the cohort

  - name: project_template
    type: file
    label: The project template for new projects 
    help: The path to the project template file that will be used for new projects. Default templates are available in the repository (Legacy_Frequency_Cohort_Template_GRCh37.vsproject-template and Legacy_Frequency_Cohort_Template_GRCh38.vsproject-template)


steps:
  - name: create_cohort
    description: Create the initial cohort
    type: cmd
    docker:
      image: ${VSPIPELINE_DOCKER_IMAGE}
    args:
      - |-
        #!/usr/bin/env bash
        set -xe


        # Find the latest version of the project 
        echo "Searching for the latest project version in $project_base_path"

        export GOLDENHELIX_USERDATA="${WORKSPACE_DIR}/AppData"
        export GH_CRASH_DUMP_DIR="${project_base_path}/gh_crash_dump"
        mkdir -p "${GH_CRASH_DUMP_DIR}"

        if [ -d "/scratch" ]; then
          export GH_TEMPDIR="/scratch"
        fi

        # Find all unique folders containing .vsproject files, sorted by number after last '-'
        newest_project=$(find "${project_base_path}" -name "*.vsproject" -type f -printf '%h\n' | \
                        sort -u | \
                        while read dir; do 
                            # Extract the number after the last '-' from the directory name
                            dir_name=$(basename "$dir")
                            if [[ "$dir_name" == *-* ]]; then
                                number_part=${dir_name##*-}
                                # Validate that the extracted part is numeric
                                if [[ "$number_part" =~ ^[0-9]+$ ]]; then
                                    # Pad with zeros for lexicographic sorting (assumes max 6 digits)
                                    printf "%06d %s\n" "$number_part" "$dir"
                                else
                                    # If not numeric, use 0 as the number
                                    printf "%06d %s\n" "0" "$dir"
                                fi
                            else
                                # If no '-' found, use 0 as the number
                                printf "%06d %s\n" "0" "$dir"
                            fi
                        done | \
                        sort -nr | \
                        head -1 | \
                        cut -d' ' -f2-)

        project_count=1
        if [[ -z "$newest_project" ]]; then
            echo "No existing projects found!"
        else
            # Extract number after the last '-' using bash parameter expansion
            dir_name=$(basename "$newest_project")
            if [[ "$dir_name" == *-* ]]; then
                project_count=${dir_name##*-}
                if [[ ! "$project_count" =~ ^[0-9]+$ ]]; then
                    echo "Error: Unable to extract valid numeric project count from directory name: $newest_project"
                    echo "Expected format: project_name-NUMBER, but found: $dir_name"
                    exit 1
                fi
                project_count=$((project_count + 1))
            else
                echo "Error: Directory name does not contain '-' separator: $newest_project"
                echo "Expected format: project_name-NUMBER"
                exit 1
            fi
        fi
        
        new_project="${project_base_path}/${project_name}-${project_count}"

        # Check if we found any results
        echo "Newest project found: $newest_project"
        if [[ -z "$newest_project" ]]; then
            echo "No folders containing .vsproject files found"
            echo "A new project will be created"

            if [[ ! -f "${project_template}" ]]; then
              echo "Project template file not found: $project_template"             
              exit 1
            fi

        cat <<EOF > run_batch.vs-batch
          get_version
          get_license_info
          project_create "${new_project}"  "${project_template}"  
          import "${files_to_add}" 
          download_required_sources 
          task_wait continue_on_error=True 
          run_saved_exports 
          get_task_list 
          project_save 
          project_close
        EOF

        else
          echo "Newest folder: $newest_project"

        cat <<EOF > run_batch.vs-batch
          get_version
          get_license_info
          project_open "${newest_project}" 
          import "${files_to_add}" "${new_project}" 
          download_required_sources 
          task_wait continue_on_error=True 
          run_saved_exports 
          get_task_list 
          project_save
          project_close
        EOF

        fi

        /opt/vspipeline/vspipeline.bin -c batch file=run_batch.vs-batch








